name: Build & Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger redeployment via Platform API
        run: |
          RESPONSE=$(curl -s -X POST \
            "https://sylphx.com/api/v1/apps/${{ vars.PLATFORM_APP_ID }}/deploy" \
            -H "Authorization: Bearer ${{ secrets.PLATFORM_API_TOKEN }}" \
            -H "Content-Type: application/json")
          echo "Platform response: $RESPONSE"
          # Accept both new deployment and already-queued as success
          echo "$RESPONSE" | grep -qE '"deploymentId"|already' && echo "✅ Deployment triggered" || (echo "❌ Failed: $RESPONSE" && exit 1)
